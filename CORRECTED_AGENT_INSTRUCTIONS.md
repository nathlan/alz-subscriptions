# Azure Landing Zone Vending Agent Instructions

**Repository:** `nathlan/alz-subscriptions`  
**Agent:** `alz-vending` (self-service orchestrator)  
**Module Version:** v1.0.4 (Azure Landing Zone Vending)  
**Last Updated:** 2026-02-11

---

## Overview

The `alz-vending` agent orchestrates the self-service provisioning of complete Azure landing zones (subscriptions) with automated networking, identity management, and optional budgets. The repository follows a **map-based architecture** using Terraform v1.0.4, where all landing zones are defined in a single `terraform/terraform.tfvars` configuration file.

### Key Capabilities

- ✅ Subscription creation and management group association
- ✅ Virtual network with hub peering and automatic subnet allocation
- ✅ User-managed identity with OIDC federated credentials
- ✅ Budget creation with notification thresholds
- ✅ Auto-generated resource naming (module handles all naming)
- ✅ Automatic address space calculation from base CIDR

### What This Agent Does NOT Do

- ❌ Create individual Terraform files per landing zone (map-based instead)
- ❌ Generate GitHub workflows for this repo (workflow already exists)
- ❌ Create workload repositories (separate process)
- ❌ Generate resource names (module auto-generates all names)
- ❌ Manage per-landing-zone state files (single shared state file)

---

## Architecture Overview

### Repository Structure

```
alz-subscriptions/
├── terraform/
│   ├── main.tf                 # Module instantiation
│   ├── variables.tf            # Variable definitions
│   ├── terraform.tfvars        # Landing zones configuration (single map)
│   ├── backend.tf              # Terraform backend configuration
│   ├── outputs.tf              # Outputs
│   └── .terraform-version      # Required Terraform version
├── .github/
│   └── workflows/
│       └── terraform-deploy.yml # Existing CI/CD workflow
└── README.md
```

### Configuration Pattern

The repository uses a **single `terraform.tfvars` file** containing a map of landing zones:

```hcl
# terraform/terraform.tfvars

subscription_billing_scope       = "PLACEHOLDER_BILLING_SCOPE"
subscription_management_group_id = "Corp"
hub_network_resource_id          = "PLACEHOLDER_HUB_VNET_ID"
github_organization              = "nathlan"
azure_address_space              = "10.100.0.0/16"

tags = {
  managed_by       = "terraform"
  environment_type = "production"
}

landing_zones = {
  # Existing entries...
  
  example-app-prod = {
    workload = "example-app"
    env      = "prod"
    team     = "platform-engineering"
    location = "uksouth"
    
    subscription_tags = { ... }
    spoke_vnet = { ... }
    budget = { ... }
    federated_credentials_github = { ... }
  }
  
  # New entries added here by PRs
}
```

### Key Design Decisions

| Aspect | Implementation | Rationale |
|--------|----------------|-----------|
| **Landing Zone Map** | Single `landing_zones` map in `terraform.tfvars` | Centralized configuration, easier validation |
| **Address Spaces** | Prefix size only (e.g., `/24`) | Module auto-calculates from base CIDR `10.100.0.0/16` |
| **Resource Names** | Auto-generated by module | Consistent naming, reduced human error |
| **State File** | Single `landing-zones/main.tfstate` | Unified state management for all landing zones |
| **CI/CD** | Existing `terraform-deploy.yml` workflow | No per-LZ workflows needed |

---

## Input Validation

Before proceeding with any infrastructure changes, the agent must validate all user inputs:

### User Inputs

The agent receives structured input from the user with the following fields:

| Field | Format | Requirements | Example |
|-------|--------|--------------|---------|
| `workload_name` | kebab-case | 3-30 chars, alphanumeric + hyphens | `payments-api` |
| `environment` | String | One of: `Production`, `Development`, `Test` | `Production` |
| `location` | Azure region | Valid Azure region code | `uksouth`, `australiaeast` |
| `team_name` | Alphanumeric | Team name (must exist in GitHub org) | `payments-team` |
| `address_space` | CIDR notation | Full address (e.g., `10.100.5.0/24`) | `10.100.5.0/24` |
| `cost_center` | String | Cost center code | `CC-4521` |
| `team_email` | Email | Team contact email | `payments-team@example.com` |

### Validation Rules

1. **workload_name validation:**
   - ✓ Length 3-30 characters
   - ✓ Kebab-case format (lowercase letters, numbers, hyphens)
   - ✓ Starts with lowercase letter
   - ✓ Does not conflict with existing landing zone keys

2. **environment validation:**
   - ✓ Convert user input to normalized form:
     - "Production" → `env: "prod"`
     - "Development" → `env: "dev"`
     - "Test" → `env: "test"`

3. **location validation:**
   - ✓ Valid Azure region code (e.g., `uksouth`, `australiaeast`, `eastus2`)
   - Use Azure regions list for validation

4. **address_space validation:**
   - ✓ Valid CIDR notation (e.g., `10.100.5.0/24`)
   - ✓ Must be within base address space `10.100.0.0/16`
   - ✓ No overlap with existing landing zone address spaces
   - ✓ **Convert to prefix size:** `10.100.5.0/24` → `/24` (for configuration)

5. **team_name validation:**
   - ✓ Verify team exists in GitHub organization `nathlan`
   - Use GitHub API to check team membership

6. **cost_center validation:**
   - ✓ Non-empty string
   - ✓ Maximum 50 characters

7. **team_email validation:**
   - ✓ Valid email format
   - ✓ Non-empty

### Duplicate & Overlap Detection

Before proposing any configuration:

1. **Read existing `terraform/terraform.tfvars`**
2. **Parse the HCL** to extract all existing landing zone entries
3. **Check for key conflicts:**
   - Compute candidate landing zone key: `{workload_name}-{env_abbrev}` (e.g., `payments-api-prod`)
   - Reject if key already exists in `landing_zones` map
4. **Check for address space overlaps:**
   - Extract all existing `spoke_vnet.ipv4_address_spaces[*].address_space_cidr` from parsed config
   - Verify new address space doesn't overlap with any existing range
   - Example: If `10.100.1.0/24` exists, reject `10.100.1.128/25` (overlap)

---

## Orchestration Flow

### Phase 0: Validate & Report

**Triggered:** User submits landing zone request  
**Actions:**
1. Validate all input fields (see Validation Rules above)
2. Read `terraform/terraform.tfvars` and parse HCL
3. Detect duplicates and overlaps
4. **STOP and report errors** if any validation fails
5. **Proceed to Phase 1** if all validations pass

**Output on Success:**
```
✅ All validations passed!

Landing Zone Summary:
- Key: payments-api-prod
- Workload: payments-api
- Environment: prod
- Team: payments-team
- Location: uksouth
- Address Space: 10.100.5.0/24 → /24 (prefix size)
- Cost Center: CC-4521
- Budget: [configured/not configured]
- GitHub OIDC: [enabled/not configured]

Ready to create PR for Azure subscription provisioning.
```

**Output on Failure:**
```
❌ Validation failed:

1. Address Space Overlap
   - New: 10.100.1.0/24
   - Conflicts with: 10.100.1.0/24 (existing-app-prod)

2. Team Not Found
   - Team 'payments-team' not found in nathlan organization

Please resolve these issues and try again.
```

### Phase 1: Create Azure Subscription PR

**Triggered:** User confirms after Phase 0 validation  
**Prerequisites:**
- All Phase 0 validations passed
- Agent has read access to `terraform/terraform.tfvars`
- Agent has create/push access to repository

**Actions:**

1. **Read existing configuration:**
   ```bash
   # Read current terraform/terraform.tfvars
   # Parse HCL to extract current landing_zones map
   ```

2. **Compute landing zone key:**
   ```hcl
   # Normalize environment to abbreviation
   env_abbrev = substr(environment, 0, 3) | lower  # prod, dev, test
   lz_key = "${workload_name}-${env_abbrev}"        # payments-api-prod
   ```

3. **Build landing zone configuration:**
   ```hcl
   landing_zones = {
     # ... existing entries preserved ...
     
     payments-api-prod = {
       workload = "payments-api"
       env      = "prod"
       team     = "payments-team"
       location = "uksouth"
       
       subscription_tags = {
         cost_center = "CC-4521"
         owner       = "payments-team"
       }
       
       spoke_vnet = {
         ipv4_address_spaces = {
           default_address_space = {
             address_space_cidr = "/24"  # PREFIX SIZE ONLY
             subnets = {
               default = {
                 subnet_prefixes = ["/26"]
               }
               app = {
                 subnet_prefixes = ["/26"]
               }
             }
           }
         }
       }
       
       budget = {
         monthly_amount             = 500
         alert_threshold_percentage = 80
         alert_contact_emails       = ["payments-team@example.com"]
       }
       
       federated_credentials_github = {
         repository = "payments-api"
       }
     }
   }
   ```

4. **Write updated `terraform.tfvars`:**
   - Preserve all existing entries
   - Append new landing zone entry
   - Maintain consistent formatting and comments

5. **Create branch:**
   ```bash
   git checkout -b lz/{workload_name}  # e.g., lz/payments-api
   git add terraform/terraform.tfvars
   git commit -m "feat(lz): Add landing zone — {workload_name}"
   git push origin lz/{workload_name}
   ```

6. **Create Pull Request:**
   ```
   Title: feat(lz): Add landing zone — payments-api
   
   Body:
   Adds a new production landing zone for the payments-api workload.
   
   **Landing Zone Details:**
   - Key: payments-api-prod
   - Workload: payments-api
   - Environment: Production
   - Team: payments-team
   - Location: uksouth
   - Address Space: 10.100.5.0/24
   - Cost Center: CC-4521
   - Contact: payments-team@example.com
   
   **Infrastructure Created:**
   - Azure subscription (production tier)
   - Virtual network with 2 subnets (/26 each)
   - User-managed identity with GitHub OIDC
   - Budget alert at 80% threshold ($500/month)
   
   **Next Steps:**
   1. Review this PR for configuration accuracy
   2. Merge to trigger `terraform-deploy.yml` workflow
   3. Workflow applies Terraform and provisions resources
   4. Review outputs for subscription ID and identity details
   5. Share subscription access with team
   
   Closes #[tracking-issue-number]
   ```

7. **Output PR confirmation:**
   ```
   ✅ Azure Subscription PR created!
   
   PR: #42 — feat(lz): Add landing zone — payments-api
   Branch: lz/payments-api
   File: terraform/terraform.tfvars
   
   Link: https://github.com/nathlan/alz-subscriptions/pull/42
   
   The Terraform workflow will automatically deploy when this PR is merged.
   ```

### Phase 2: Track & Report

**Triggered:** PR created successfully  
**Actions:**

1. **Create tracking issue:**
   ```bash
   # Create issue in nathlan/alz-subscriptions
   Title: [LZ] Provision payments-api-prod landing zone
   
   Body:
   Tracking issue for landing zone provisioning.
   
   **Details:**
   - Workload: payments-api
   - Environment: Production
   - PR: #42
   
   **Status Checklist:**
   - [ ] PR approved and merged
   - [ ] terraform-deploy.yml workflow completed
   - [ ] Subscription created (ID: [pending])
   - [ ] Virtual network deployed (ID: [pending])
   - [ ] User identity created (Client ID: [pending])
   - [ ] Budget configured (monthly: $500)
   - [ ] Team granted subscription access
   - [ ] Documentation updated
   ```

2. **Track PR status:**
   - Monitor PR for approval/merge
   - Poll GitHub API for workflow runs triggered by merge
   - Update tracking issue with workflow status

3. **Extract and report key outputs:**
   - Subscription ID
   - Virtual network name and ID
   - User-managed identity details
   - Budget configuration status

4. **Final status report:**
   ```
   ✅ Landing Zone Provisioning Complete!
   
   **Subscription Details:**
   - Subscription ID: /subscriptions/12345678-...
   - Name: sub-payments-api-prod
   
   **Networking:**
   - Virtual Network: vnet-payments-api-prod-uksouth
   - Address Space: 10.100.5.0/24
   - Subnets: default (/26), app (/26)
   - Hub Peering: Connected (auto-configured)
   
   **Identity:**
   - Managed Identity: mia-payments-api-prod
   - Client ID: [client-id]
   - GitHub OIDC: Enabled for repository 'payments-api'
   
   **Budget:**
   - Monthly Amount: $500
   - Alert Threshold: 80% ($400)
   - Notification Email: payments-team@example.com
   
   **Next Steps for Team:**
   1. Clone workload repository (if not existing)
   2. Configure application for Azure deployments
   3. Update GitHub Actions secrets with subscription ID
   4. Grant team members subscription access via Azure Portal
   5. Test OIDC federated credentials in CI/CD
   
   Tracking Issue: #[issue-number]
   ```

---

## Configuration Reference

### Current Repository Values

```yaml
# Azure Configuration
tenant_id: PLACEHOLDER                    # TODO: Update with actual Azure tenant ID
billing_scope: PLACEHOLDER                # TODO: Update with EA/MCA billing scope

# Networking
azure_address_space: "10.100.0.0/16"     # Base CIDR for automatic allocation
hub_network_resource_id: PLACEHOLDER      # TODO: Update with Hub VNet resource ID

# Repository & Organization
github_organization: "nathlan"            # GitHub org for OIDC credentials
alz_infra_repo: "alz-subscriptions"      # This repository
module_version: "v1.0.4"                  # Azure Landing Zone Vending module

# Terraform Backend (State File)
state_resource_group: "rg-terraform-state"
state_storage_account: "stterraformstate"
state_container: "alz-subscriptions"
state_key: "landing-zones/main.tfstate"   # Single state file for all landing zones

# Common Tags
tags:
  managed_by: "terraform"
  environment_type: "production"
```

### Landing Zone Input Schema

```hcl
landing_zones = {
  "{workload}-{env}" = {
    # Required Fields
    workload = "short-identifier"         # e.g., "payments-api"
    env      = "prod|dev|test"            # Environment abbreviation
    team     = "team-name"                # Owning team name
    location = "azure-region"             # e.g., "uksouth", "australiaeast"
    
    # Optional: Subscription Configuration
    subscription_devtest_enabled = false  # Use DevTest offer (false = Production)
    subscription_tags = {
      cost_center = "CC-1234"
      owner       = "team-name"
      # ... other tags ...
    }
    
    # Optional: Networking
    dns_servers = []                      # Custom DNS (empty = Azure default)
    spoke_vnet = {
      ipv4_address_spaces = {
        default_address_space = {
          address_space_cidr = "/24"      # PREFIX SIZE ONLY, not full CIDR!
          subnets = {
            default = {
              subnet_prefixes = ["/26"]   # Can have multiple subnets
            }
            app = {
              subnet_prefixes = ["/26"]
            }
          }
        }
      }
    }
    
    # Optional: Budget
    budget = {
      monthly_amount             = 500     # USD
      alert_threshold_percentage = 80      # Alert at 80% of budget
      alert_contact_emails       = ["team@example.com"]
    }
    
    # Optional: GitHub OIDC Federated Credentials
    federated_credentials_github = {
      repository = "repository-name"      # e.g., "payments-api"
    }
  }
}
```

### Address Space Calculation

The module automatically calculates actual CIDR ranges from the base address space and prefix sizes:

```
Base Address Space: 10.100.0.0/16

Prefix Size /24 → Actual Range: 10.100.{0-255}.0/24
Example:
  Landing Zone 1: /24 → 10.100.1.0/24
  Landing Zone 2: /24 → 10.100.2.0/24
  Landing Zone 3: /24 → 10.100.3.0/24

Subnet Calculation:
  Parent CIDR: 10.100.5.0/24
  Subnet 1: /26 → 10.100.5.0/26
  Subnet 2: /26 → 10.100.5.64/26
  Subnet 3: /26 → 10.100.5.128/26
  Subnet 4: /26 → 10.100.5.192/26
```

**Important:** Always provide **prefix size only** (e.g., `/24`), not full CIDR. The module handles all CIDR calculations.

---

## Error Handling & Recovery

### Common Validation Errors

#### 1. Address Space Overlap

```
❌ Validation Failed: Address Space Overlap

New address space: 10.100.5.0/24
Conflicts with existing: 10.100.5.0/24 (existing-app-prod)

Suggestion: Try 10.100.6.0/24 or 10.100.7.0/24
```

**Resolution:**
- Agent should suggest available ranges within `10.100.0.0/16`
- User selects alternate address space and resubmits

#### 2. Duplicate Landing Zone Key

```
❌ Validation Failed: Duplicate Landing Zone

Key 'payments-api-prod' already exists!

Existing:
  workload: payments-api
  env: prod
  team: payments-team

Suggestion: Use different workload name or environment
```

**Resolution:**
- User must choose unique workload name + environment combination
- Resubmit with new parameters

#### 3. Invalid Team Name

```
❌ Validation Failed: Team Not Found

Team 'payments-team' not found in GitHub organization 'nathlan'

Available teams:
- platform-engineering
- security-ops
- data-engineering

Please choose an existing team or create the team first.
```

**Resolution:**
- Create team in GitHub organization first
- Resubmit request with valid team name

#### 4. Invalid Location

```
❌ Validation Failed: Invalid Azure Region

Location 'uk-south' is not a valid Azure region code.

Valid regions in UK:
- uksouth
- ukwest

Please use the standard Azure region code.
```

**Resolution:**
- Use standard Azure region codes
- Resubmit with corrected location

### PR Merge & Terraform Apply

After PR is merged, the `terraform-deploy.yml` workflow automatically:

1. Runs `terraform validate` and `terraform plan`
2. Applies configuration if plan succeeds
3. Outputs subscription ID, VNet ID, and identity details

**Success Indicators:**
- Workflow job completes with exit code 0
- Outputs section shows resource IDs
- No "resource already exists" errors

**If apply fails:**
- Review workflow logs for error messages
- Common causes:
  - Billing scope invalid
  - Management group ID not found
  - Hub VNet resource ID invalid
- Contact infrastructure team to update PLACEHOLDERS in `terraform.tfvars`
- Fix and retry

---

## Terraform Module Reference

### Module Source

```hcl
module "landing_zones" {
  source = "github.com/nathlan/terraform-azurerm-landing-zone-vending?ref=v1.0.4"
  
  # Configuration passed directly from variables
  subscription_billing_scope       = var.subscription_billing_scope
  subscription_management_group_id = var.subscription_management_group_id
  hub_network_resource_id          = var.hub_network_resource_id
  github_organization              = var.github_organization
  azure_address_space              = var.azure_address_space
  tags                             = var.tags
  landing_zones                    = var.landing_zones
}
```

### Module Capabilities (v1.0.4)

| Feature | Available? | Details |
|---------|-----------|---------|
| Subscription Creation | ✅ Yes | Full subscription with EA/MCA support |
| Auto-Generated Naming | ✅ Yes | Follows Azure naming conventions |
| VNet with Hub Peering | ✅ Yes | Auto-peered to hub network |
| Automatic Address Calculation | ✅ Yes | From base CIDR and prefix sizes |
| User-Managed Identity | ✅ Yes | With OIDC federated credentials |
| Budget & Alerts | ✅ Yes | Email notifications |
| Role Assignments | ✅ Yes | Auto-configured for identity |

### Module Outputs

The module outputs the following for each landing zone:

```hcl
outputs = {
  "{lz_key}" = {
    subscription_id        = "string"    # Azure subscription ID
    subscription_name      = "string"    # Subscription name
    resource_group_id      = "string"    # Auto-created resource group
    vnet_id                = "string"    # Virtual network ID
    vnet_name              = "string"    # Virtual network name
    user_identity_id       = "string"    # Managed identity resource ID
    user_identity_client_id = "string"   # Client ID for OIDC
    user_identity_principal_id = "string" # Principal ID for role assignments
    budget_id              = "string"    # Budget resource ID (if configured)
  }
}
```

---

## Security Considerations

### Access Control

- **Subscription Access:** Granted via Azure RBAC (post-provisioning)
- **GitHub OIDC:** Credentials valid only for specified repository
- **State File:** Stored in secure Azure Storage with RBAC access

### Secrets & Credentials

- ✅ OIDC federated credentials (no secrets stored)
- ✅ No hardcoded passwords or keys in configuration
- ✅ All credentials managed by Azure

### Terraform Backend

- Storage account has encryption enabled (TLS + server-side)
- Access restricted to Azure AD identities
- State file contains sensitive data (properly protected)

---

## Workflow Integration

### GitHub Actions Workflow

The repository includes `terraform-deploy.yml` which:

1. **Triggers on:** PR merge to default branch
2. **Steps:**
   - Authenticates with Azure (OIDC)
   - Runs `terraform validate`
   - Runs `terraform plan` (review)
   - Runs `terraform apply` (if approved)
   - Extracts and publishes outputs

3. **Outputs published to:**
   - Workflow summary
   - PR comment (for plan step)
   - Issue comment (from tracking issue)

### No Per-Landing-Zone Workflows

- ❌ Do NOT create per-LZ workflows
- ✅ Use existing centralized workflow
- ✅ Workflow handles all landing zones in `terraform.tfvars`

---

## Examples

### Example 1: Basic Production Landing Zone

```hcl
payments-api-prod = {
  workload = "payments-api"
  env      = "prod"
  team     = "payments-team"
  location = "uksouth"
  
  subscription_tags = {
    cost_center = "CC-4521"
    owner       = "payments-team"
  }
  
  spoke_vnet = {
    ipv4_address_spaces = {
      default_address_space = {
        address_space_cidr = "/24"
        subnets = {
          default = { subnet_prefixes = ["/26"] }
          app     = { subnet_prefixes = ["/26"] }
        }
      }
    }
  }
}
```

### Example 2: Development with Budget

```hcl
reporting-engine-dev = {
  workload = "reporting-engine"
  env      = "dev"
  team     = "analytics-team"
  location = "australiaeast"
  
  subscription_tags = {
    cost_center = "CC-5890"
    owner       = "analytics-team"
  }
  
  spoke_vnet = {
    ipv4_address_spaces = {
      default_address_space = {
        address_space_cidr = "/24"
        subnets = {
          compute = { subnet_prefixes = ["/26"] }
          database = { subnet_prefixes = ["/27"] }
        }
      }
    }
  }
  
  budget = {
    monthly_amount             = 250
    alert_threshold_percentage = 75
    alert_contact_emails       = ["analytics-team@example.com"]
  }
}
```

### Example 3: Production with GitHub OIDC

```hcl
microservice-api-prod = {
  workload = "microservice-api"
  env      = "prod"
  team     = "backend-engineering"
  location = "eastus2"
  
  subscription_tags = {
    cost_center = "CC-7123"
    owner       = "backend-engineering"
    criticality = "high"
  }
  
  spoke_vnet = {
    ipv4_address_spaces = {
      default_address_space = {
        address_space_cidr = "/23"
        subnets = {
          api      = { subnet_prefixes = ["/26"] }
          database = { subnet_prefixes = ["/26"] }
          ingress  = { subnet_prefixes = ["/28"] }
        }
      }
    }
  }
  
  budget = {
    monthly_amount             = 1500
    alert_threshold_percentage = 80
    alert_contact_emails       = ["backend-engineering@example.com", "ops@example.com"]
  }
  
  federated_credentials_github = {
    repository = "microservice-api"
  }
}
```

---

## Troubleshooting

### PR Creation Fails

**Error:** "Cannot write to terraform/terraform.tfvars"

**Causes:**
- Repository not cloned with write permissions
- Branch protection rules preventing direct writes
- File locked by concurrent operation

**Resolution:**
- Verify agent has push access to repository
- Check branch protection settings
- Retry after a short delay

### Terraform Validation Fails

**Error:** "Invalid HCL in terraform.tfvars"

**Causes:**
- Malformed map entry (missing braces, commas, etc.)
- Invalid variable types
- Conflicting key names

**Resolution:**
- Review PR diff for syntax errors
- Agent should validate HCL before pushing
- Use `terraform validate` locally to verify

### Address Space Calculation Issues

**Error:** "CIDR block overlaps with existing address space"

**Causes:**
- Address space not within base range `10.100.0.0/16`
- Overlap with existing landing zone
- Hub network conflict

**Resolution:**
- Verify address space is within `10.100.0.0/16`
- Run overlap detection before validation
- Contact infrastructure team for larger address space

### Missing Placeholders

**Error:** "subscription_billing_scope is PLACEHOLDER_BILLING_SCOPE"

**Causes:**
- Repository configuration not initialized with actual Azure values
- Placeholders not updated by infrastructure team

**Resolution:**
- Contact infrastructure team to update:
  - `subscription_billing_scope`
  - `hub_network_resource_id`
- Cannot proceed with provisioning until these are set

---

## FAQ

### Q: Can I add multiple subnets to a landing zone?

**A:** Yes! In the `spoke_vnet.ipv4_address_spaces.{name}.subnets` map, add multiple entries:

```hcl
subnets = {
  web      = { subnet_prefixes = ["/26"] }
  app      = { subnet_prefixes = ["/26"] }
  database = { subnet_prefixes = ["/27"] }
  admin    = { subnet_prefixes = ["/28"] }
}
```

The module automatically calculates actual CIDR ranges for each subnet.

### Q: What prefix sizes should I use?

**A:** This depends on your workload:

- `/24` parent → up to 4 subnets of `/26` (64 IPs each)
- `/23` parent → up to 8 subnets of `/26` (64 IPs each)
- `/22` parent → up to 16 subnets of `/26` (64 IPs each)

For most applications, `/26` subnets are sufficient. Use `/27` or `/28` for smaller workloads.

### Q: Can I enable DevTest offer?

**A:** Yes! Set `subscription_devtest_enabled = true`:

```hcl
example-dev = {
  workload = "example"
  env      = "dev"
  team     = "engineering"
  location = "uksouth"
  subscription_devtest_enabled = true  # Uses DevTest offer
  # ... rest of configuration ...
}
```

DevTest subscriptions have lower costs but different usage policies.

### Q: How do I configure GitHub OIDC?

**A:** Add `federated_credentials_github` block:

```hcl
federated_credentials_github = {
  repository = "your-repo-name"  # Repository in nathlan org
}
```

This enables GitHub Actions workflows to authenticate to Azure without storing secrets.

### Q: What happens after the PR is merged?

**A:** The `terraform-deploy.yml` workflow automatically:

1. Validates your configuration
2. Plans all resources
3. Applies and creates Azure subscription
4. Publishes subscription ID and other outputs
5. Updates the tracking issue with results

No manual intervention needed!

### Q: Can I modify a landing zone after creation?

**A:** Yes! Edit the corresponding map entry in `terraform.tfvars` and create a new PR. The Terraform workflow will apply changes. Common modifications:

- Budget amounts
- Alert thresholds
- Alert email addresses
- Adding/removing subnets
- Subscription tags

**⚠️ Caution:** Some changes (like workload name or environment) require careful planning, as they affect resource naming.

### Q: How is the state file managed?

**A:** All landing zones share a single state file (`landing-zones/main.tfstate`) in Azure Storage. This ensures:

- ✅ Consistent resource dependencies
- ✅ Atomic updates for multiple landing zones
- ✅ Simplified backup and recovery
- ✅ Centralized state management

You do not need to create or manage individual state files.

### Q: What if I need to delete a landing zone?

**A:** Remove the map entry from `terraform/terraform.tfvars` and create a PR. Terraform will destroy all associated resources on merge. **⚠️ This is destructive and cannot be undone!**

Before deletion:
1. Export any critical data
2. Drain workloads
3. Get approval from team owner
4. Document the deletion reason

---

## Support & Escalation

### Common Support Cases

| Issue | Escalation |
|-------|------------|
| Configuration syntax help | Review examples and variable schema in this document |
| Azure service limits (IP ranges, subscriptions) | Contact Azure Infrastructure team |
| GitHub OIDC not working | Contact Security/Platform team |
| Terraform state corruption | Contact DevOps/SRE team |
| Budget alerts not working | Check alert email configuration and Azure settings |

### Contact Information

- **Infrastructure Team:** [team-email]
- **Azure Access Issues:** [azure-admin-email]
- **GitHub OIDC Support:** [security-team-email]
- **Billing/Cost Center Questions:** [finance-email]

---

## Revision History

| Date | Version | Changes |
|------|---------|---------|
| 2026-02-11 | 1.0 | Initial corrected agent instructions (map-based architecture, v1.0.4 module) |

---

**Status:** ✅ ALIGNED WITH REPOSITORY ARCHITECTURE  
**Last Verified:** 2026-02-11  
**Next Review:** When module version changes or terraform.tfvars structure changes
