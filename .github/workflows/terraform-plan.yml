name: Terraform Plan

# ============================================================================
# MULTI-WORKLOAD CHILD WORKFLOW
# ============================================================================
# This workflow discovers all .tfvars files in the landing-zones/ directory
# and processes each workload by calling jobs from the centralized reusable
# workflow, maintaining multi-workload capability while demonstrating reuse
# of standardized validation and security patterns.
#
# Architecture:
# 1. Discovery job finds all .tfvars files
# 2. Validation and security jobs (called once, shared across all workloads)
# 3. Plan jobs run in parallel for each workload using matrix strategy
# 4. Summary job aggregates results and posts to PR
# ============================================================================

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # ============================================================================
  # Job 1: Discovery - Find all .tfvars files to process
  # ============================================================================
  discover:
    name: Discover Workloads
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      workload-count: ${{ steps.set-matrix.outputs.count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Discover tfvars files
        id: set-matrix
        run: |
          # Find all .tfvars files in landing-zones directory
          tfvars_files=$(find landing-zones -name "*.tfvars" -type f | sort)

          if [ -z "$tfvars_files" ]; then
            echo "No .tfvars files found in landing-zones directory"
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build JSON array for matrix
          matrix_json="{"
          matrix_json+="\"include\":["

          first=true
          count=0
          for tfvars_file in $tfvars_files; do
            workload_name=$(basename "$tfvars_file" .tfvars)

            if [ "$first" = false ]; then
              matrix_json+=","
            fi
            first=false

            matrix_json+="{"
            matrix_json+="\"workload\":\"$workload_name\","
            matrix_json+="\"tfvars-file\":\"$tfvars_file\""
            matrix_json+="}"

            count=$((count + 1))
          done

          matrix_json+="]}"

          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "count=$count" >> $GITHUB_OUTPUT

          echo "Found $count workload(s):"
          echo "$matrix_json" | jq '.'

  # ============================================================================
  # Job 2: Validation - Follows centralized pattern
  # ============================================================================
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    needs: discover
    if: needs.discover.outputs.workload-count != '0'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: TFLint Init
        run: tflint --init

      - name: Run TFLint
        id: tflint
        run: tflint --format=compact

      - name: Comment Validation Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### TFLint üìñ\`${{ steps.tflint.outcome }}\`

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ============================================================================
  # Job 3: Security - Follows centralized pattern
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: |
          python -m pip install --upgrade pip
          python -m pip install checkov

      - name: Run Checkov
        id: checkov
        run: |
          checkov --directory . \
            --output cli \
            --output junitxml \
            --output-file-path console,checkov-report.xml \
            --soft-fail false
        continue-on-error: false

      - name: Upload Checkov Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.xml
          retention-days: 30

  # ============================================================================
  # Job 4: Plan - Process each workload in parallel using matrix
  # ============================================================================
  plan:
    name: Plan (${{ matrix.workload }})
    runs-on: ubuntu-latest
    needs: [discover, validate, security]
    if: needs.discover.outputs.workload-count != '0'

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: terraform init
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Plan for ${{ matrix.workload }}
        id: plan
        run: |
          echo "Running plan for workload: ${{ matrix.workload }}"
          echo "Using var file: ${{ matrix.tfvars-file }}"

          terraform plan \
            -var-file="${{ matrix.tfvars-file }}" \
            -no-color \
            -out=tfplan-${{ matrix.workload }} \
            -input=false

          terraform show -no-color tfplan-${{ matrix.workload }} > plan-${{ matrix.workload }}.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: plan-${{ matrix.workload }}
          path: |
            tfplan-${{ matrix.workload }}
            plan-${{ matrix.workload }}.txt
          retention-days: 30

      - name: Comment Plan Result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('plan-${{ matrix.workload }}.txt', 'utf8');

            // Truncate if too long for GitHub comment
            const maxLength = 60000;
            let truncatedOutput = planOutput;
            if (planOutput.length > maxLength) {
              truncatedOutput = planOutput.substring(0, maxLength) + '\n\n... (truncated)';
            }

            const output = `### üìã Terraform Plan: \`${{ matrix.workload }}\`

            **Var file:** \`${{ matrix.tfvars-file }}\`
            **Status:** ‚úÖ Success

            <details>
            <summary>Show Plan Output</summary>

            \`\`\`terraform
            ${truncatedOutput}
            \`\`\`

            </details>

            *Plan artifact uploaded for apply step*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ============================================================================
  # Job 5: Summary - Aggregate results and post to PR
  # ============================================================================
  summary:
    name: Plan Summary
    runs-on: ubuntu-latest
    needs: [discover, plan]
    if: always() && needs.discover.outputs.workload-count != '0'
    permissions:
      pull-requests: write

    steps:
      - name: Generate Summary
        uses: actions/github-script@v7
        with:
          script: |
            const workloadCount = ${{ needs.discover.outputs.workload-count }};
            const matrix = ${{ needs.discover.outputs.matrix }};
            const planResult = '${{ needs.plan.result }}';

            let comment = '## üîç Terraform Plan Summary\n\n';
            comment += `**PR:** #${context.issue.number}\n`;
            comment += `**Commit:** ${context.sha.substring(0, 7)}\n`;
            comment += `**Workloads Discovered:** ${workloadCount}\n`;
            comment += `**Overall Status:** ${planResult === 'success' ? '‚úÖ All plans succeeded' : '‚ùå Some plans failed'}\n\n`;
            comment += '---\n\n';

            comment += '### Workloads Processed:\n\n';
            for (const item of matrix.include) {
              comment += `- \`${item.workload}\` (${item['tfvars-file']})\n`;
            }

            comment += '\n---\n\n';
            comment += `**Workflow Run:** [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;
            comment += `*Terraform v1.9.0 ‚Ä¢ Triggered by @${context.actor}*\n`;

            // Post comment to PR
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

            // Set job summary
            core.summary.addRaw(comment).write();
